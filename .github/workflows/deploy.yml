name: Deploy PriceFind AI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  NODE_VERSION: '20'

jobs:
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          echo "Starting npm install..."
          echo "Node.js version:"
          node --version
          echo "npm version:"
          npm --version
          echo "Current directory:"
          pwd
          echo "Contents:"
          ls -la
          echo "Installing dependencies with npm ci alternative..."
          timeout 300 npm install --force --prefer-offline --no-audit
        timeout-minutes: 10

      - name: Build application
        run: |
          echo "Starting build process..."
          echo "Skipping TypeScript check for deployment..."
          echo "Running build..."
          npm run build
        timeout-minutes: 15

      - name: Run tests
        run: npm test

  deploy:
    name: Deploy to Vercel
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build Project Artifacts
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy Project Artifacts to Vercel
        run: vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: Create deployment URL output
        run: echo "DEPLOYMENT_URL=$(vercel ls --prod --token=${{ secrets.VERCEL_TOKEN }} | grep -E 'https://[^[:space:]]+' | head -1)" >> $GITHUB_ENV

      - name: Comment PR with deployment URL
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const url = process.env.DEPLOYMENT_URL;
            if (url) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `ðŸš€ Deployment successful! Live at: ${url}`
              });
            }
